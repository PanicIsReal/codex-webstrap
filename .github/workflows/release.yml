name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

concurrency:
  group: release
  cancel-in-progress: true

jobs:
  tag-check:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - name: Validate tag matches versions
        shell: bash
        run: |
          set -euo pipefail
          [[ "${GITHUB_REF_TYPE}" == "tag" ]] || { echo "Not a tag push"; exit 1; }
          [[ "${GITHUB_REF_NAME}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-(alpha|beta)(\.[0-9]+)?)?$ ]] \
            || { echo "Tag '${GITHUB_REF_NAME}' does not match vX.Y.Z or vX.Y.Z-alpha.N"; exit 1; }

          tag_ver="${GITHUB_REF_NAME#v}"
          cargo_ver="$(grep -m1 '^version' Cargo.toml | sed -E 's/version *= *\"([^\"]+)\".*/\1/')"
          npm_ver="$(python3 - <<'PY'
          import json
          with open("package.json", "r", encoding="utf-8") as fh:
              print(json.load(fh)["version"])
          PY
          )"

          echo "Tag version: ${tag_ver}"
          echo "Cargo version: ${cargo_ver}"
          echo "NPM version: ${npm_ver}"

          [[ "${tag_ver}" == "${cargo_ver}" ]] || { echo "Tag ${tag_ver} != Cargo.toml ${cargo_ver}"; exit 1; }
          [[ "${tag_ver}" == "${npm_ver}" ]] || { echo "Tag ${tag_ver} != package.json ${npm_ver}"; exit 1; }

  verify:
    needs: tag-check
    runs-on: ubuntu-24.04
    env:
      CARGO_INCREMENTAL: "0"
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: taiki-e/install-action@cargo-audit
      - uses: taiki-e/install-action@cargo-nextest
      - name: Cache cargo bin
        uses: actions/cache@v5
        continue-on-error: true
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
          restore-keys: |
            ${{ runner.os }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
      - uses: Swatinem/rust-cache@v2
        continue-on-error: true
        with:
          shared-key: ${{ runner.os }}-verify-${{ hashFiles('rust-toolchain.toml') }}
      - name: Run checks
        run: scripts/check.sh

  build:
    needs: verify
    name: build-${{ matrix.target }}
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: true
      matrix:
        include:
          - runner: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
            binary: codex-profiles
          - runner: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            binary: codex-profiles
          - runner: macos-15-large
            target: x86_64-apple-darwin
            binary: codex-profiles
          - runner: macos-15
            target: aarch64-apple-darwin
            binary: codex-profiles
          - runner: windows-2025
            target: x86_64-pc-windows-msvc
            binary: codex-profiles.exe

    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Cache cargo bin
        uses: actions/cache@v5
        continue-on-error: true
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
      - uses: Swatinem/rust-cache@v2
        continue-on-error: true
        with:
          shared-key: ${{ runner.os }}-${{ matrix.target }}-${{ hashFiles('rust-toolchain.toml') }}
      - name: Cargo build
        shell: bash
        run: |
          set -euo pipefail
          cargo fetch --locked
          cargo build --release --target ${{ matrix.target }} --bin codex-profiles --locked
          echo "Build output:"
          ls -la target/${{ matrix.target }}/release || true
      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: codex-profiles-${{ matrix.target }}
          path: target/${{ matrix.target }}/release/${{ matrix.binary }}
          if-no-files-found: error

  package:
    needs: [build, verify]
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/setup-node@v6
        with:
          node-version: 20
      - name: Cache cargo bin
        uses: actions/cache@v5
        continue-on-error: true
        with:
          path: ~/.cargo/bin
          key: ${{ runner.os }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
          restore-keys: |
            ${{ runner.os }}-${{ hashFiles('rust-toolchain.toml') }}-cargo-bin
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/artifacts
      - name: Build release artifacts
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          scripts/release-artifacts.sh "${version}" dist/artifacts dist
          scripts/verify-artifacts.sh "${version}" dist

      - name: Commit checksums to repo
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME#v}"
          
          # Safety gate: only commit to production repository
          if [[ "${GITHUB_REPOSITORY}" != "midhunmonachan/codex-profiles" ]]; then
            echo "Skipping checksum commit: not production repository (current: ${GITHUB_REPOSITORY})"
            echo "Checksums generated but not committed to repo"
            ls -la dist/checksums/
            exit 0
          fi
          
          echo "Committing checksums to ${GITHUB_REPOSITORY}..."
          
          # Copy checksums to repo
          cp dist/checksums/SHA256SUMS "checksums/v${version}.txt"
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Fetch and checkout main branch (workflow starts in detached HEAD from tag)
          git fetch origin main
          git checkout main
          
          # Commit and push
          git add "checksums/v${version}.txt"
          git commit -m "chore: add checksums for v${version}"
          git push origin main

      - name: Publish to crates.io
        if: ${{ !contains(github.ref_name, '-') }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          # Safety gate: only publish from production repository
          if [[ "${GITHUB_REPOSITORY}" != "midhunmonachan/codex-profiles" ]]; then
            echo "Skipping crates.io publish: not production repository (current: ${GITHUB_REPOSITORY})"
            exit 0
          fi
          
          if [ -z "${CARGO_REGISTRY_TOKEN}" ]; then
            echo "Warning: CARGO_REGISTRY_TOKEN not set, skipping crates.io publish"
            echo "Add your token at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 0
          fi
          
          echo "Publishing to crates.io from ${GITHUB_REPOSITORY}..."
          cargo publish --locked --token "${CARGO_REGISTRY_TOKEN}"

      - name: Publish to npm
        if: ${{ !contains(github.ref_name, '-') }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Safety gate: only publish from production repository
          if [[ "${GITHUB_REPOSITORY}" != "midhunmonachan/codex-profiles" ]]; then
            echo "Skipping npm publish: not production repository (current: ${GITHUB_REPOSITORY})"
            exit 0
          fi
          
          if [ -z "${NODE_AUTH_TOKEN}" ]; then
            echo "Warning: NPM_TOKEN not set, skipping npm publish"
            echo "Add your token at: https://github.com/${{ github.repository }}/settings/secrets/actions"
            exit 0
          fi
          
          echo "Publishing to npm from ${GITHUB_REPOSITORY}..."
          version="${GITHUB_REF_NAME#v}"
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > ~/.npmrc
          
          # Publish main package
          npm publish dist/npm-packages/codex-profiles-${version}.tgz --access public
          
          # Publish platform packages
          for pkg in dist/npm-packages/codex-profiles-*-*.tgz; do
            npm publish "$pkg" --access public
          done

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/release/*
            dist/npm-packages/*.tgz
            dist/homebrew/*.rb
            dist/cargo/*.crate
            dist/checksums/*
          generate_release_notes: true
          prerelease: ${{ contains(github.ref_name, '-') }}
